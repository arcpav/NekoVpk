<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:NekoVpk.ViewModels"
             xmlns:lang="clr-namespace:NekoVpk.Lang"
             mc:Ignorable="d"
             d:DesignWidth="800"
             d:DesignHeight="450"
             x:Class="NekoVpk.Views.MainView"
             x:Name="RootView"
             x:DataType="vm:MainViewModel"
             FontFamily="{Binding UserFont}"
             FontSize="{Binding UserFontSize}">
  <Design.DataContext>
    <vm:MainViewModel />
  </Design.DataContext>
  <Panel>
    <Panel>
      <Image Source="{Binding BackgroundImage}"
             Stretch="{Binding BackgroundStretch}"/>
      <Rectangle Fill="Black"
                 Opacity="{Binding BackgroundDimOpacity}"
                 IsHitTestVisible="False"/>
    </Panel>
    <Grid RowDefinitions="auto,auto,*" Margin="13 10 10 10">
      <DockPanel Grid.Row="0">
        <StackPanel DockPanel.Dock="Right"
                    Margin="10"
                    Orientation="Horizontal"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Center"
                    Spacing="5">
          <Button Classes="Primary"
                  Theme="{DynamicResource SolidButton}"
                  Height="32"
                  Margin="20 0 0 0"
                  Content="{x:Static lang:Resources.Scan}"
                  ToolTip.Tip="Refresh"
                  Click="Button_Click"/>
          <Button Click="Settings_Button_Click">Settings</Button>
          <Menu VerticalAlignment="Center">
            <MenuItem Header="All Select â–¼">
              <MenuItem Header="å‹¾é€‰" Click="MenuItem_SelectAll_Click"/>
              <MenuItem Header="å–æ¶ˆ" Click="MenuItem_DeselectAll_Click"/>
              <MenuItem Header="åé€‰" Click="MenuItem_InvertSelection_Click"/>
            </MenuItem>
          </Menu>
        </StackPanel>
        <StackPanel DockPanel.Dock="Left" 
                    VerticalAlignment="Center" 
                    Orientation="Horizontal" 
                    Spacing="10">
          <TextBox Text="{Binding SearchKeywords}"
                   InnerLeftContent="{Binding SearchWatermark}"
                   Width="600"
                   Height="32"
                   KeyUp="TextBox_AddonSearch_KeyUp"
                   TextChanged="TextBox_AddonSearch_TextChanged"/>
          
          <Button Content="ðŸ·ï¸" 
                  Height="32" 
                  ToolTip.Tip="Tags Filter"
                  IsVisible="{Binding IsOnlineMode}">
            <Button.Flyout>
              <Flyout Placement="Bottom">
                <Border Width="300" Height="400">
                  <Grid RowDefinitions="*, auto">
                    <ScrollViewer Grid.Row="0">
                      <ItemsControl ItemsSource="{Binding WorkshopTagCategories}">
                        <ItemsControl.ItemTemplate>
                          <DataTemplate>
                            <StackPanel Margin="0,0,0,10">
                              <TextBlock Text="{Binding Header}" 
                                         FontWeight="Bold" 
                                         Foreground="{DynamicResource SystemAccentColor}"
                                         Margin="0,0,0,5"/>
                              <ItemsControl ItemsSource="{Binding Tags}">
                                <ItemsControl.ItemsPanel>
                                  <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                  </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                  <DataTemplate>
                                    <CheckBox Content="{Binding Display}" 
                                              IsChecked="{Binding IsSelected}" 
                                              Margin="0,0,10,2"/>
                                  </DataTemplate>
                                </ItemsControl.ItemTemplate>
                              </ItemsControl>
                            </StackPanel>
                          </DataTemplate>
                        </ItemsControl.ItemTemplate>
                      </ItemsControl>
                    </ScrollViewer>
                    <Button Grid.Row="1" 
                            Content="é‡ç½®æ ‡ç­¾" 
                            HorizontalAlignment="Stretch" 
                            HorizontalContentAlignment="Center"
                            Click="Button_ResetTags_Click"
                            Margin="0,5,0,0"/>
                  </Grid>
                </Border>
              </Flyout>
            </Button.Flyout>
          </Button>

          <ToggleButton Content="ðŸŒ"
                        ToolTip.Tip="Search Workshop"
                        IsChecked="{Binding IsOnlineMode}"
                        Height="32" 
                        VerticalAlignment="Center"/>
          <StackPanel Orientation="Horizontal" 
                      Spacing="5" 
                      VerticalAlignment="Center"
                      IsVisible="{Binding IsDownloading}">
              <ProgressBar Value="{Binding DownloadProgress}" 
                           Minimum="0" Maximum="100" 
                           Width="100" Height="20"
                           ShowProgressText="True"/>
              <Button Content="âŒ" 
                      Height="32" Width="32"
                      Classes="Danger"
                      Padding="0"
                      HorizontalContentAlignment="Center"
                      VerticalContentAlignment="Center"
                      Click="Button_CancelDownload_Click"
                      ToolTip.Tip="å–æ¶ˆä¸‹è½½"/>
          </StackPanel>
        </StackPanel>
      </DockPanel>
      <Grid Grid.Row="1"
            Margin="13 0 10 10"
            ColumnDefinitions="*,auto,auto"
            VerticalAlignment="Center"
            HorizontalAlignment="Left"/>
      <Grid Grid.Row="2"
            ColumnDefinitions="*,auto,0.3*"
            RowDefinitions="*"
            MinHeight="360">
        <Panel Grid.Column="0">
            <DataGrid Name="AddonList"
                      ItemsSource="{Binding Addons}"
                      HorizontalScrollBarVisibility="Auto"
                      IsReadOnly="False"
                      AutoGenerateColumns="False"
                      CanUserResizeColumns="True"
                      CanUserReorderColumns="True"
                      GridLinesVisibility="Vertical"
                      CurrentCellChanged="DataGrid_CurrentCellChanged"
                      BeginningEdit="DataGrid_BeginningEdit"
                      CellEditEnded="DataGrid_CellEditEnded"
                      DoubleTapped="AddonList_DoubleTapped"
                      Sorting="DataGrid_Sorting">
              <DataGrid.ContextMenu>
                <ContextMenu>
                  <MenuItem Header="æ‰“å¼€ç›®å½•"
                            Click="AddonList_Menu_LocateFile"
                            IsVisible="{Binding !DataContext.IsOnlineMode, ElementName=RootView}"/>
                  <MenuItem Header="åˆ é™¤æ¨¡ç»„"
                            Click="AddonList_Menu_Delete"
                            IsVisible="{Binding !DataContext.IsOnlineMode, ElementName=RootView}"/>
                  <MenuItem Header="è·³è½¬ç½‘é¡µ"
                            Click="AddonList_Menu_OpenPage"
                            IsVisible="{Binding DataContext.IsOnlineMode, ElementName=RootView}"/>
                  <MenuItem Header="ä¸‹è½½æ¨¡ç»„"
                            Click="AddonList_Menu_Download"
                            IsVisible="{Binding DataContext.IsOnlineMode, ElementName=RootView}"/>
                </ContextMenu>
              </DataGrid.ContextMenu>
              <DataGrid.Columns>
                <DataGridTextColumn Header="" Width="0"/>
                <DataGridCheckBoxColumn Header="Enable"
                                        Binding="{Binding Enable}"
                                        Width="85"
                                        IsVisible="{Binding !DataContext.IsOnlineMode, ElementName=RootView}"/>   
                <DataGridTextColumn Header="Title"
                                    Binding="{Binding Title}"
                                    Width="360"/>
                <DataGridTextColumn Header="Source"
                                    Binding="{Binding Source}"
                                    Width="auto"/>
                <DataGridTextColumn Header="Author"
                                    Binding="{Binding Author}"
                                    Width="100"/>
                <DataGridTemplateColumn Header="Tag"
                                        Width="130"
                                        SortMemberPath="TagsOrde"
                                        IsVisible="{Binding !DataContext.IsOnlineMode, ElementName=RootView}">
                  <DataGridTemplateColumn.CellTemplate>
                    <DataTemplate>
                      <ItemsControl ItemsSource="{Binding Tags}">
                        <ItemsControl.ItemsPanel>
                          <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal"
                                       VerticalAlignment="Center"
                                       Margin="4"/>
                          </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                          <DataTemplate>
                            <Label Theme="{StaticResource TagLabel}"
                                   Content="{Binding Name}"
                                   Margin="1"
                                   Classes.Ghost="{Binding !Enable}"
                                   Loaded="AssetTag_Label_Loaded"/>
                          </DataTemplate>
                        </ItemsControl.ItemTemplate>
                      </ItemsControl>
                    </DataTemplate>
                  </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Type"
                                    Binding="{Binding Type}"
                                    Width="100"/>
                <DataGridTextColumn Header="Added time"
                                    Binding="{Binding CreationTimeStr}"
                                    SortMemberPath="CreationTime"
                                    IsVisible="{Binding !DataContext.IsOnlineMode, ElementName=RootView}"/>
                <DataGridTextColumn Header="Size"
                                    Binding="{Binding FileSize}"
                                    SortMemberPath="FileSizeRaw"
                                    Width="90"/>
                <DataGridTextColumn Header="Last update"
                                    Binding="{Binding LastUpdateStr}"
                                    SortMemberPath="LastUpdate"
                                    IsVisible="{Binding DataContext.IsOnlineMode, ElementName=RootView}"/>
                <DataGridTextColumn Header="Sub"
                                    Binding="{Binding Subscriptions}"
                                    Width="65"
                                    IsVisible="{Binding DataContext.IsOnlineMode, ElementName=RootView}"/>
              </DataGrid.Columns>
            </DataGrid>
            <TextBlock Text="æœªçŸ¥å¼‚å¸¸"
                       FontSize="24"
                       FontWeight="Bold"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Foreground="White"
                       IsVisible="{Binding ShowNotImplemented}"
                       IsHitTestVisible="False"/>
        </Panel>
        <GridSplitter Grid.Column="1" ResizeDirection="Columns"/>
        <ScrollViewer Grid.Column="2" AllowAutoHide="True">
          <StackPanel Name="AddonDetailPanel"
                      Orientation="Vertical"
                      IsVisible="False">
            <Border Background="{StaticResource ThemeBackgroundBrush}"
                    Margin="10">
              <Image Name="AddonImage"
                     MaxHeight="128"
                     MinWidth="256"/>
            </Border>
            <Grid Margin="10"
                  RowDefinitions="auto,auto,auto,auto,auto,auto,auto,auto"
                  ColumnDefinitions="*">
              <TextBox Grid.Row="0"
                       InnerLeftContent="Title"
                       Text="{Binding #AddonList.SelectedItem.Title}"
                       Classes="s1 Small Bordered"/>
              <TextBox Grid.Row="1"
                       InnerLeftContent="Version"
                       Text="{Binding #AddonList.SelectedItem.Version}"
                       Classes="s1 Small Bordered"/>
              <TextBox Grid.Row="2"
                       InnerLeftContent="Author"
                       Text="{Binding #AddonList.SelectedItem.Author}"
                       Classes="s1 Small Bordered"/>
              <TextBox Grid.Row="3"
                       InnerLeftContent="File"
                       Text="{Binding #AddonList.SelectedItem.FileName}"
                       Classes="s1 Small Bordered"/>
              <TextBox Grid.Row="4"
                       Classes="TextArea"
                       Text="{Binding #AddonList.SelectedItem.Description}"
                       Padding="10 8"
                       TextWrapping="WrapWithOverflow"/>
              <StackPanel Grid.Row="5">
                <ItemsControl ItemsSource="{Binding #AddonList.SelectedItem.Tags}">
                  <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                      <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                  </ItemsControl.ItemsPanel>
                  <ItemsControl.ItemTemplate>
                    <DataTemplate>
                      <Label Theme="{StaticResource TagLabel}"
                             Content="{Binding Name}"
                             Margin="2"
                             Classes="Large"
                             Classes.Ghost="{Binding !Enable}"
                             Loaded="AssetTag_Label_Loaded"
                             Tapped="AssetTag_Tapped"/>
                    </DataTemplate>
                  </ItemsControl.ItemTemplate>
                </ItemsControl>
                <Grid Name="AssetTagModifiedPanel"
                      ColumnDefinitions="*,*"
                      Margin="2">
                  <Button Grid.Column="0"
                          Classes="Danger"
                          Margin="0 0 1 0"
                          Click="Button_AssetTagModifiedPanel_Apply">
                    Apply
                  </Button>
                  <Button Grid.Column="1"
                          Classes="Secondary"
                          Margin="1 0 0 0"
                          Click="Button_AssetTagModifiedPanel_Cancel">
                    Cancel
                  </Button>
                </Grid>
              </StackPanel>
              <StackPanel Grid.Row="6" Margin="2,10,2,5" IsVisible="{Binding IsOnlineMode}">
                  <Button Classes="Accent"
                          HorizontalAlignment="Stretch"
                          HorizontalContentAlignment="Center"
                          IsVisible="{Binding !#AddonList.SelectedItem.IsInstalled}"
                          Click="Button_Download_Click">
                      <StackPanel Orientation="Horizontal" Spacing="5">
                          <TextBlock Text="â˜"/>
                          <TextBlock Text="Download to Addons"/>
                      </StackPanel>
                  </Button>
                  <Button IsEnabled="False"
                          HorizontalAlignment="Stretch"
                          HorizontalContentAlignment="Center"
                          IsVisible="{Binding #AddonList.SelectedItem.IsInstalled}">
                      <StackPanel Orientation="Horizontal" Spacing="5">
                          <TextBlock Text="âœ”"/>
                          <TextBlock Text="Downloaded"/>
                      </StackPanel>
                  </Button>
              </StackPanel>
              <Panel Grid.Row="7"
                     HorizontalAlignment="Center"
                     Margin="3">
                <HyperlinkButton NavigateUri="{Binding #AddonList.SelectedItem.Url}">
                  <TextBlock Text="{Binding #AddonList.SelectedItem.Url}"
                             TextDecorations="Underline"/>
                </HyperlinkButton>
              </Panel>
            </Grid>
          </StackPanel>
        </ScrollViewer>
      </Grid>
    </Grid>
  </Panel>
</UserControl>